---
title: Replication
---

```{r include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE,
                      message = FALSE)

```


```{r load_libraries}

library(tidyverse)

library(tidymodels)

library(readxl)

library(stargazer)

```


```{r setup}

theme_set(theme_bw() + theme(legend.position = "bottom",
                             legend.title = element_blank()))

```


```{r params}

params = list()

params$xreg_vars = c(
  "yield_slope",
  "credit",
  "stock_price",
  "debt_ratio",
  "consumption",
  "investment",
  "current_account",
  "public_debt",
  "broad_money",
  "cpi"
)

params$vars_to_rates = c(
  "cpi",
  "consumption",
  "stock_price"
)

params$vars_to_diff = c(
  "credit",
  "broad_money",
  "public_debt",
  "debt_ratio",
  "investment",
  "current_account"
)

params$vars_to_gdp = c(
  "broad_money",
  "credit",
  "current_account")

```


```{r import_data}

df = read_xlsx(paste0(
  file.path(Sys.getenv("USERPROFILE")),
  "\\OneDrive - Bank Of Israel\\Data\\",
  "MacroHistory\\JSTdatasetR3.xlsx"), sheet = "Data") %>% 
  rename(credit = tloans,
         stock_price = stocks,
         consumption = rconpc,
         investment = iy,
         current_account = ca,
         public_debt = debtgdp,
         broad_money = money) %>% 
  mutate(yield_slope = ltrate - stir) %>% 
  mutate(debt_ratio = credit * ltrate / gdp)



```


# EDA

The data set spans the period for `r paste0(range(df$year), collapse = "-")` for `r length(unique(df$iso))` countries. The countries are mainly European leaders as well as Japan and USA.


```{r cleaning_up_data}

clean_df = df %>% 
  filter(!year %in% c(1914:1918, 1933:1939, 1939:1945)) %>% 
  group_by(country) %>% 
  arrange(year) %>% 
  mutate(lead_crisis = if_else(
    lead(crisisJST) == 1 | lead(crisisJST,2) == 1,1,0)) %>% 
  mutate(lead_crisis = factor(lead_crisis, levels = c(1,0))) %>% 
  filter(!year %in% c(sapply(year[crisisJST == 1],
                                  function(temp){temp + 0:4}))) %>% 
  mutate(across(params$vars_to_gdp, ~ . / gdp)) %>% 
  mutate(across(params$vars_to_rates, ~ (. / lag(.)) - 1)) %>% 
  mutate(across(params$vars_to_diff, ~c(NA,NA, diff(.,2)))) %>% 
  ungroup() %>% 
  select(params$xreg_vars, lead_crisis) %>% 
  filter(complete.cases(.))



```


```{r compare_crisis_vs_non_crisis, results="asis", eval=FALSE}

clean_df %>% 
  filter(crisisJST == 0) %>% 
  select(-c("crisisJST","iso")) %>% 
  mutate(lead_crisis = recode(lead_crisis,
                              `0` = "Normal",`1` = "Build_up")) %>% 
  pivot_longer(-c("year","lead_crisis")) %>% 
  group_by(lead_crisis, name) %>% 
  summarise(avg = mean(value)) %>% 
  pivot_wider(names_from = lead_crisis, values_from = avg) %>%
  as.data.frame() %>% 
  stargazer(type = "html",summary = FALSE, digits = 2,
            rownames = FALSE)
  

```



# Models


```{r models_spec}


models_df = list(logit = logistic_reg() %>% 
       set_engine("glm"),
     tree = decision_tree(mode = "classification") %>% 
       set_engine("C5.0")
     ) %>% 
  enframe(value = "model_spec")


```



```{r models_fit}

models_df = models_df %>% 
  mutate(models_wf = map(model_spec,function(temp_spec){
    
  temp_fit = workflow() %>% 
  add_formula(formula = formula("lead_crisis ~ .")) %>% 
  add_model(temp_spec) %>% 
  fit(data = clean_df)
    
  return(temp_fit)
    
  }))


```



```{r predictions}

models_df = models_df %>% 
  mutate(models_pred = map(models_wf,function(temp_wf){
    
  temp_pred = clean_df %>% 
  select(lead_crisis) %>% 
  bind_cols(predict(temp_wf, clean_df,type = "prob"))
    
  return(temp_pred)
    
  })) %>% 
  mutate(score = map(models_pred,function(temp_pred){
    
    temp_score = temp_pred %>% 
      roc_auc(truth = lead_crisis,.pred_1) %>% 
      pull(".estimate")
    
    return(temp_score)
    
  }))
    


```


# Results

```{r table}

logit_fit %>% 
  pull_workflow_fit() %>% 
  tidy() %>% 
  gt::gt()

```


```{r plot_df}

logit_fit %>% 
  pull_workflow_fit() %>% 
  tidy() %>% 
  filter(!term == "(Intercept)") %>% 
  ggplot(aes(x = reorder(term, estimate), y = estimate,
             fill = (p.value < 0.05))) + 
  geom_col() + 
  scale_fill_manual(values = c("lightblue","lightgrey")) + 
  coord_flip()


```

